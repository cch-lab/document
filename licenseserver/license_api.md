## Service activation process

![](images/license_active_flowchart.png)

Step1: After the user orders or updates the service, the Catalog generates subscription information, notifies each buy to generate service instances, and synchronizes the subscription information to the License Server.

Step2: After the License Server obtains the subscription information, it generates the license information.

Step3: After the service instance is started, obtain the license from the license server through API.

Step4: After the service instance obtains the license, compare its own information with the information in the license according to the rules, and verify that the activation is successful. Otherwise, the activation fails.

## API overview

### Authorization code acquisition interface

| API | Description |
| API                                                          | 描述                   |
| ------------------------------------------------------------ | ---------------------- |
| /v1/api/partNum/licenseQty | Obtain authorization code by service part number |
| /v1/api/serviceName/ [serviceName]/serviceInstanceId/ [serviceInstanceId] | Obtain authorization code by service name |
| /v1/api/licenses/serviceName/[serviceName]/username/[username] |Get the authorization code by user name and service name |


## API interface
### Authorization code acquisition interface
#### Obtain authorization code by service item number

Calling /v1/api/partNum/licenseQty can obtain the activation code through the service item number (pn) and service instance id (id)

##### Request parameters

| Name | Type | Required or Not | Example | Description |
| ---- | ------ | -------- | ---------------------------- ----------------------- | -------------------------- ---------------------------------- |
| pn | Stirng | Yes | 9806WPDASH | The service item number provided when the service was launched, namely PN |
| id | String | Yes | eks00120a957f4-0bf9-4faf-90cd-694919cd4b68Dashboard | Service instance id, namely serviceInstanceId. If it is an App, the generation rule is clustername+workspaceId+namespaceName (excluding +); if it is another service, it is generated by the Managed Service when subscribing|

##### Return data

| Name | Type | Example Value | Description |
| ------------------ | ------- | ---------------------- ----------------------------- | -------------------- ------------------------------------- |
| id | String | eks00120a957f4-0bf9-4faf-90cd-694919cd4b68Dashboard | Service instance id, namely serviceInstanceId |
| subscriptionId | String | ff4fbd21-5962-4427-88a0-b8ef4ac9b393 | Subscription ID |
| isValidTransaction | Boolean | true | User subscription status, true=valid, false=invalid, if invalid, activation fails |
| number | Int | 1 | The number of subscribed item numbers, namely pnQuantity |
| authcode | String | 3080-e825-003c | Activation Code |
| datacenterCode | String | sa | Data center code, such as sa, hz, je |
| activeInfo | String | "" | Customized activation information when the service is launched, reserved item |
| company | String | Advantech | Company information of the subscription number |
| subscriptionType | String | paid | Subscription type (paid/trial), value: paid/on trial |

##### Example

**Request example**

```
GET http://api.license.ensaas.en.internal/v1/api/partNum/licenseQty?pn=9806WPDASH&id=eks00120a957f4-0bf9-4faf-90cd-694919cd4b68Dashboard
```

**Example of normal return**

```
{
"id": "eks00120a957f4-0bf9-4faf-90cd-694919cd4b68Dashboard",  //service instance id
"subscriptionId": "ff4fbd21-5962-4427-88a0-b8ef4ac9b393",  //Subscription ID
"isValidTransaction": true,  //User subscription status, true=valid, false=invalid
"number": 120,  // The number of subscribed item numbers
"authcode": "3080-e825-003c",  //Activation code
"datacenterCode":"sa",  //site information
"activeInfo": "",  //Customized activation information when the service is launched
"company": "Advantech",
"subscriptionType": "paid"
}
```

##### Return code

| Http Code | Description |
| --------- | --------------------------------------- --------------------- |
| 200 | successful operation, the returned json data format is as described in the Response Example above |
| 204 | *no content*, lic information is not found |


#### Obtain authorization code by service name

Call /v1/api/serviceName/[serviceName]/serviceInstanceId/[serviceInstanceId] to get the activation code by the service name (serviceName) and service instance id (serviceInstanceId)

##### Request parameters

| Name | Type | Required or Not | Example Value | Description |
| ----------------- | ------ | -------- | --------------- ---------------------------------- | --------------- ------------------- |
| serviceName | String | Yes | Dashboard | The service name provided when the service is available |
| serviceInstanceId | String | yes | eks00145b957f4-0bf9-4faf-90cd-694200cd4b74Datahub | service instance id |
| page | Int | No | 1 | Which page of the query result, the default is 1 |
| pageSize | Int | No | 10 | The number of results displayed on each page of query results, the default is 10 |

##### Return data

| Name | Type | Example Value | Description |
| ------------------ | ------- | ---------------------- ----------------------- | -------------------------- ------------------------------- |
| total | Int | 3 | Total number of activation codes found |
| id | String | eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm | Service instance id, namely serviceInstanceId |
| pn | String | 9806WPDASH | The service item number provided when the service was launched, namely PN |
| subscriptionId | String | 2e687325-2f50-43c8-b221-771ea517c40b | Subscription ID |
| isValidTransaction | Boolean | true | User subscription status, true=valid, false=invalid, if invalid, activation fails |
| number | Int | 1 | The number of subscribed item numbers, namely pnQuantity |
| authcode | String | a7d7-7d48-0001 | Activation code |
| datacenterCode | String | sa | Data center code, such as sa, hz, je |
| activeInfo | String | "" | Customized activation information when the service is launched, reserved item |
| company | String | Advantech | Company information of the subscription number |
| subscriptionType | String | paid | Subscription type (paid/trial), value: paid/on trial |

##### Example

**Request example**

```
GET http://api.license.ensaas.en.internal/v1/api/serviceName/APM/serviceInstanceId/eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm?page=1&pageSize=100
```

**Example of normal return**

```
{
    "total":2,
    "resources":[
        {
            "id":"eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm",
            "pn":"9806WPAPM1",
            "subscriptionId":"2e687325-2f50-43c8-b221-771ea517c40b",
            "datacenterCode":"sa",
            "isValidTransaction":true,
            "number":1,
            "authcode":"a7d7-7d48-0001",
            "activeInfo":"",
            "company": "Advantech",
            "subscriptionType": "paid"
        },
        {
            "id":"eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm",
            "pn":"9806WPAPM4",
            "subscriptionId":"2e687325-2f50-43c8-b221-771ea517c40b",
            "datacenterCode":"sa",
            "isValidTransaction":true,
            "number":1,
            "authcode":"c3b5-e711-0001",
            "activeInfo":""
            "company": "Advantech",
            "subscriptionType": "paid"
        }
    ]
}
```

##### Return code
| Http Code | Description |
| ------------- | ----------------------------------- ------------------------- |
| 200 | *successful operation*, the returned json data format is as described in the Response Example above. |


#### Obtain authorization code by username and service name

Call /v1/api/licenses/serviceName/[serviceName]/username/[username] to get the activation code by service name (serviceName) and user name (username)

##### Request parameters

| Name | Type | Required or Not | Example Value | Description |
| ----------------- | ------ | -------- | --------------- ---------------------------------- | --------------- ------------------- |
| serviceName | String | Yes | Dashboard | The service name provided when the service is available |
| username | String | Yes | test@advantech.com.cn | User E-mail |
| page | Int | No | 1 | Which page of the query result, the default is 1 |
| pageSize | Int | No | 10 | The number of results displayed on each page of query results, the default is 10 |

##### Return data

| Name | Type | Example Value | Description |
| ------------------ | ------- | ---------------------- ----------------------- | -------------------------- ------------------------------- |
| total | Int | 3 | Total number of activation codes found |
| id | String | eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm | Service instance id, namely serviceInstanceId |
| pn | String | 9806WPDASH | The service item number provided when the service was launched, namely PN |
| subscriptionId | String | 2e687325-2f50-43c8-b221-771ea517c40b | Subscription ID |
| isValidTransaction | Boolean | true | User subscription status, true=valid, false=invalid, if invalid, activation fails |
| number | Int | 1 | The number of subscribed item numbers, namely pnQuantity |
| authcode | String | a7d7-7d48-0001 | Activation code |
| datacenterCode | String | sa | Data center code, such as sa, hz, je |
| activeInfo | String | "" | Customized activation information when the service is launched, reserved item |
| company | String | Advantech | Company information of the subscription number |
| subscriptionType | String | paid | Subscription type (paid/trial), value: paid/on trial |

##### Example

**Request example**

```
GET http://api.license.ensaas.en.internal/v1/api/licenses/serviceName/Dashboard/username/test@advantech.com.cn?page=1&pageSize=100
```

**Example of normal return**

```
{
    "total":2,
    "resources":[
        {
            "id":"eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm",
            "pn":"9806WPAPM1",
            "subscriptionId":"2e687325-2f50-43c8-b221-771ea517c40b",
            "datacenterCode":"sa",
            "isValidTransaction":true,
            "number":1,
            "authcode":"a7d7-7d48-0001",
            "activeInfo":"",
            "company": "Advantech",
            "subscriptionType": "paid"
        },
        {
            "id":"eks00145b957f4-0bf9-4faf-90cd-694200cd4b74apm",
            "pn":"9806WPAPM4",
            "subscriptionId":"2e687325-2f50-43c8-b221-771ea517c40b",
            "datacenterCode":"sa",
            "isValidTransaction":true,
            "number":1,
            "authcode":"c3b5-e711-0001",
            "activeInfo":"",
            "company": "Advantech",
            "subscriptionType": "paid"
        }
    ]
}
```

##### Return code
| Http Code | Description |
| ------------- | ----------------------------------- ------------------------- |
| 200 | *successful operation*, the returned json data format is as described in the Response Example above|
